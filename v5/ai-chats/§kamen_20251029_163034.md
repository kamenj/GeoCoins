Â§kamen_20251029_163034

# Chat Log: Fix Bottom Menu Position After Exiting Fullscreen

## Issue
After exiting fullscreen mode, the bottom menu was going under/behind the help content view.

## Root Causes Identified

1. **DOM Positioning Issue**: When `menuBottom` was restored from fullscreen using `appendChild()`, it was placed at the END of the parent's children, which put it AFTER the Help section instead of BEFORE it (its original position).

2. **Missing State Preservation**: The collapsed/expanded states of sections and menus were not being preserved during fullscreen enter/exit transitions.

3. **Inline Styles Not Cleared**: Body element inline styles set during fullscreen mode were persisting after exit, causing layout conflicts.

## Solutions Implemented

### 1. Fixed DOM Restoration Order
- Save `menuBottom`'s `nextSibling` (Help section) when entering fullscreen
- Use `insertBefore(menuBottom, nextSibling)` instead of `appendChild()` when exiting fullscreen
- This ensures `menuBottom` is restored to its exact original position BEFORE the Help section

### 2. Preserve Collapsed/Expanded States
**When entering fullscreen:**
- Save collapsed states for all content sections in `State.fullScreen.preFullScreenState.collapsedStates`
- Save collapsed states for `menuTop`, `menuBottom`, and `help`
- Don't force `menuBottom` or `mapPoints` to expand - preserve their current state

**When exiting fullscreen:**
- Restore collapsed states for content sections immediately
- Skip menu restoration in main loop (they get re-rendered)
- Save menu collapsed states before clearing `preFullScreenState`
- Restore menu collapsed states AFTER `renderMenusFor()` completes (with 50ms delay)

### 3. Clean Up Body Inline Styles
When exiting fullscreen, explicitly clear all inline styles added to body element:
- `padding`, `margin`, `overflow`, `display`, `flexDirection`, `height`, `width`

### 4. CSS Z-Index Improvements
- Added `position: relative` and `z-index: 1` to all sections
- Added `position: relative` and `z-index: 10` to `#menuBottom` specifically
- Ensures proper stacking order when multiple sections are visible

### 5. Help Section Visibility
- Explicitly ensure Help section is visible after exiting fullscreen
- Added scroll position check to ensure `menuBottom` is visible in viewport after restoration

## Code Changes

### Files Modified:
1. `v5/app.js` - `enterMapPointsFullScreen()` and `exitMapPointsFullScreen()` functions
2. `v5/index.css` - Added z-index rules for proper stacking

### Key Code Additions:

**Saving state (enter fullscreen):**
```javascript
State.fullScreen.preFullScreenState = {
  scrollY: window.scrollY || window.pageYOffset,
  visibleSections: [],
  collapsedStates: {},
  menuBottomParent: null,
  menuBottomNextSibling: null
};
```

**Restoring position (exit fullscreen):**
```javascript
if (nextSibling && nextSibling.parentNode === parent) {
  parent.insertBefore(menuBottom, nextSibling);
} else {
  parent.appendChild(menuBottom);
}
```

**Restoring menu states (exit fullscreen):**
```javascript
setTimeout(function() {
  if (savedMenuTopCollapsed !== undefined) {
    setCollapsed(Constants.ElementId.MenuTop, savedMenuTopCollapsed);
  }
  if (savedMenuBottomCollapsed !== undefined) {
    setCollapsed(Constants.ElementId.MenuBottom, savedMenuBottomCollapsed);
  }
}, 50);
```

## Testing Notes
- Bottom menu now appears in correct position after exiting fullscreen
- Collapsed/expanded states are preserved throughout fullscreen cycle
- No layout conflicts or overlapping content
- Smooth transitions between normal and fullscreen modes
